<?php
// ... (le code PHP reste inchang√© jusqu'√† la balise <!DOCTYPE html>)
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Pointeuse LSPD</title>
    <style>
        body {
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f4f8;
            color: #333;
        }

        header {
            background-color: #002b5c;
            color: white;
            padding: 15px;
            text-align: center;
        }

        main {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        h2, h3 {
            color: #002b5c;
        }

        form {
            margin-bottom: 20px;
        }

        input, select, button {
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 300px;
            box-sizing: border-box;
        }

        button {
            background-color: #002b5c;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        button:hover {
            background-color: #0050c8;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
            background-color: #fff;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #002b5c;
            color: white;
        }

        a {
            color: #002b5c;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body>

<header>
    <h1>Pointeuse LSPD</h1>
</header>

<main>
<?php if (!is_logged_in()): ?>
    <h2>Connexion</h2>
    <form method="post">
        <label>Matricule:</label>
        <input name="matricule" required>
        <label>Mot de passe:</label>
        <input type="password" name="password" required>
        <button name="login">Se connecter</button>
    </form>

    <h2>Cr√©er un compte</h2>
    <form method="post">
        <label>Nom:</label>
        <input name="nom" required>
        <label>Pr√©nom:</label>
        <input name="prenom" required>
        <label>Matricule:</label>
        <input name="matricule" required>
        <label>Grade:</label>
        <select name="grade">
            <option>LSPD</option>
            <option>Command staff</option>
            <option>Staff</option>
        </select>
        <button name="register">Cr√©er</button>
    </form>

<?php else: $user = get_user(); ?>
    <h2>Bienvenue <?= htmlspecialchars($user['prenom']) ?> (<?= $user['grade'] ?>) ‚Äî <a href="?logout">D√©connexion</a></h2>

    <form method="post">
        <?php
        $stmt = $pdo->prepare("SELECT * FROM pointeuse WHERE user_id = ? AND end IS NULL");
        $stmt->execute([$user['id']]);
        $active = $stmt->fetch();
        ?>
        <button name="pointeuse" value="<?= $active ? 'stop' : 'start' ?>">
            <?= $active ? '‚èπÔ∏è Arr√™ter la pointeuse' : '‚ñ∂Ô∏è D√©marrer la pointeuse' ?>
        </button>
    </form>

    <h3>Mon historique</h3>
    <table>
        <tr><th>D√©but</th><th>Fin</th></tr>
        <?php
        $stmt = $pdo->prepare("SELECT * FROM pointeuse WHERE user_id = ? ORDER BY start DESC");
        $stmt->execute([$user['id']]);
        foreach ($stmt as $row) {
            echo "<tr><td>{$row['start']}</td><td>{$row['end']}</td></tr>";
        }
        ?>
    </table>

    <h3>Effectifs actifs</h3>
    <table>
        <tr><th>Nom</th><th>Pr√©nom</th><th>Grade</th><th>D√©but</th></tr>
        <?php
        $stmt = $pdo->query("SELECT u.nom, u.prenom, u.grade, p.start FROM pointeuse p JOIN users u ON p.user_id = u.id WHERE p.end IS NULL");
        foreach ($stmt as $row) {
            echo "<tr><td>{$row['nom']}</td><td>{$row['prenom']}</td><td>{$row['grade']}</td><td>{$row['start']}</td></tr>";
        }
        ?>
    </table>

    <?php if (is_command() || is_staff()): ?>
    <div class="actions">
        <form method="post">
            <button name="export">üì• Exporter en CSV</button>
        </form>
        <form method="post" onsubmit="return confirm('Confirmer la r√©initialisation ?')">
            <button name="reset">üßπ R√©initialiser la pointeuse</button>
        </form>
    </div>
    <?php endif; ?>

    <?php if (is_staff()): ?>
    <h3>Supprimer un membre</h3>
    <form method="post">
        <select name="delete_user">
            <?php
            $stmt = $pdo->query("SELECT id, nom, prenom, matricule FROM users WHERE id != " . $user['id']);
            foreach ($stmt as $u) {
                echo "<option value='{$u['id']}'>{$u['nom']} {$u['prenom']} ({$u['matricule']})</option>";
            }
            ?>
        </select>
        <button>‚ùå Supprimer</button>
    </form>
    <?php endif; ?>

<?php endif; ?>
</main>
</body>
</html>
