<?php
session_start();
$pdo = new PDO('mysql:host=localhost;dbname=pointeuse;charset=utf8', 'root', '');

// Cr√©er la base si elle n‚Äôexiste pas (√† lancer une fois)
$pdo->exec("CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nom VARCHAR(50),
    prenom VARCHAR(50),
    matricule VARCHAR(50),
    grade ENUM('LSPD','Command staff','Staff'),
    password VARCHAR(255)
)");
$pdo->exec("CREATE TABLE IF NOT EXISTS pointeuse (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    start DATETIME,
    end DATETIME,
    FOREIGN KEY(user_id) REFERENCES users(id)
)");

function is_logged_in() { return isset($_SESSION['user']); }
function get_user() { return $_SESSION['user'] ?? null; }
function is_staff() { return get_user()['grade'] === 'Staff'; }
function is_command() { return get_user()['grade'] === 'Command staff'; }

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['register'])) {
        $stmt = $pdo->prepare("INSERT INTO users (nom, prenom, matricule, grade, password) VALUES (?, ?, ?, ?, ?)");
        $stmt->execute([
            $_POST['nom'], $_POST['prenom'], $_POST['matricule'],
            $_POST['grade'], password_hash("1234", PASSWORD_DEFAULT)
        ]);
        echo "<script>alert('Compte cr√©√©. Mot de passe par d√©faut : 1234');</script>";
    }

    if (isset($_POST['login'])) {
        $stmt = $pdo->prepare("SELECT * FROM users WHERE matricule = ?");
        $stmt->execute([$_POST['matricule']]);
        $user = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($user && password_verify($_POST['password'], $user['password'])) {
            $_SESSION['user'] = $user;
        } else {
            echo "<script>alert('Identifiants invalides');</script>";
        }
    }

    if (isset($_POST['pointeuse'])) {
        $uid = get_user()['id'];
        if ($_POST['pointeuse'] === 'start') {
            $pdo->prepare("INSERT INTO pointeuse (user_id, start) VALUES (?, NOW())")->execute([$uid]);
        } else {
            $pdo->prepare("UPDATE pointeuse SET end = NOW() WHERE user_id = ? AND end IS NULL")->execute([$uid]);
        }
    }

    if (isset($_POST['reset']) && (is_command() || is_staff())) {
        $pdo->exec("TRUNCATE TABLE pointeuse");
    }

    if (isset($_POST['delete_user']) && is_staff()) {
        $stmt = $pdo->prepare("DELETE FROM users WHERE id = ?");
        $stmt->execute([$_POST['delete_user']]);
    }

    if (isset($_POST['export']) && (is_command() || is_staff())) {
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename="pointeuse.csv"');
        $stmt = $pdo->query("SELECT u.nom, u.prenom, u.grade, p.start, p.end FROM pointeuse p JOIN users u ON p.user_id = u.id");
        $f = fopen('php://output', 'w');
        fputcsv($f, ['Nom', 'Pr√©nom', 'Grade', 'D√©but', 'Fin']);
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) fputcsv($f, $row);
        fclose($f);
        exit;
    }
}

if (isset($_GET['logout'])) {
    session_destroy();
    header("Location: pointeuse.php");
    exit;
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>Pointeuse LSPD</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        form { margin-bottom: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 10px; }
        th, td { border: 1px solid #ccc; padding: 8px; }
    </style>
</head>
<body>

<?php if (!is_logged_in()): ?>
<h2>Connexion</h2>
<form method="post">
    Matricule: <input name="matricule" required>
    Mot de passe: <input type="password" name="password" required>
    <button name="login">Se connecter</button>
</form>

<h2>Cr√©er un compte</h2>
<form method="post">
    Nom: <input name="nom" required>
    Pr√©nom: <input name="prenom" required>
    Matricule: <input name="matricule" required>
    Grade:
    <select name="grade">
        <option>LSPD</option>
        <option>Command staff</option>
        <option>Staff</option>
    </select>
    <button name="register">Cr√©er</button>
</form>

<?php else: $user = get_user(); ?>
<h2>Bienvenue <?= htmlspecialchars($user['prenom']) ?> (<?= $user['grade'] ?>) - <a href="?logout">D√©connexion</a></h2>

<form method="post">
    <?php
    $stmt = $pdo->prepare("SELECT * FROM pointeuse WHERE user_id = ? AND end IS NULL");
    $stmt->execute([$user['id']]);
    $active = $stmt->fetch();
    ?>
    <button name="pointeuse" value="<?= $active ? 'stop' : 'start' ?>">
        <?= $active ? 'Arr√™ter la pointeuse' : 'D√©marrer la pointeuse' ?>
    </button>
</form>

<h3>Mon historique</h3>
<table>
    <tr><th>D√©but</th><th>Fin</th></tr>
    <?php
    $stmt = $pdo->prepare("SELECT * FROM pointeuse WHERE user_id = ? ORDER BY start DESC");
    $stmt->execute([$user['id']]);
    foreach ($stmt as $row) {
        echo "<tr><td>{$row['start']}</td><td>{$row['end']}</td></tr>";
    }
    ?>
</table>

<h3>Effectifs actifs</h3>
<table>
    <tr><th>Nom</th><th>Pr√©nom</th><th>Grade</th><th>D√©but</th></tr>
    <?php
    $stmt = $pdo->query("SELECT u.nom, u.prenom, u.grade, p.start FROM pointeuse p JOIN users u ON p.user_id = u.id WHERE p.end IS NULL");
    foreach ($stmt as $row) {
        echo "<tr><td>{$row['nom']}</td><td>{$row['prenom']}</td><td>{$row['grade']}</td><td>{$row['start']}</td></tr>";
    }
    ?>
</table>

<?php if (is_command() || is_staff()): ?>
<form method="post">
    <button name="export">üì• Exporter en CSV</button>
</form>
<form method="post" onsubmit="return confirm('Confirmer la r√©initialisation ?')">
    <button name="reset">üßπ R√©initialiser la pointeuse</button>
</form>
<?php endif; ?>

<?php if (is_staff()): ?>
<h3>Supprimer un membre</h3>
<form method="post">
    <select name="delete_user">
        <?php
        $stmt = $pdo->query("SELECT id, nom, prenom, matricule FROM users WHERE id != " . $user['id']);
        foreach ($stmt as $u) {
            echo "<option value='{$u['id']}'>{$u['nom']} {$u['prenom']} ({$u['matricule']})</option>";
        }
        ?>
    </select>
    <button>‚ùå Supprimer</button>
</form>
<?php endif; ?>

<?php endif; ?>
</body>
</html>
